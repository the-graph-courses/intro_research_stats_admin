---
title: "Diabetes Analysis"
output: html_document
---

Copied from here: https://www.kaggle.com/code/shivashankari06/diabetes-analysis-in-r/notebook 

- Won't run because file paths etc. aren't correct. 

```{r}
# This R environment comes with many helpful analytics packages installed
# It is defined by the kaggle/rstats Docker image: https://github.com/kaggle/docker-rstats
# For example, here's a helpful package to load

library(tidyverse) # metapackage of all tidyverse packages

# Input data files are available in the read-only "../input/" directory
# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory

list.files(path = "../input")

# You can write up to 20GB to the current directory (/kaggle/working/) that gets preserved as output when you create a version using "Save & Run All" 
# You can also write temporary files to /kaggle/temp/, but they won't be saved outside of the current session
```

Set a CRAN Mirror

```{r}
options(repos = c(CRAN = "https://cloud.r-project.org/"))
```

Install the Required Package

```{r}
install.packages("pscl")
```

View Variables Table

```{r}
# Load the openxlsx package
library(openxlsx)

# Load the knitr package
library(knitr)

# Read the entire sheet
variable <- read.xlsx("/kaggle/input/variable-table/other/default/1/VariableTable.xlsx")

# View the data
kable(variable)
```

Table of Summary Statistics

```{r}
# Load necessary packages
library(knitr)
library(dplyr)
library(tidyr)

# Read the dataset
data <- read.csv("/kaggle/input/diabetic-dataset/diabetes_dataset.csv")

# Function to calculate summary statistics
calc_summary_stats <- function(x) {
  c(
    Min = min(x, na.rm = TRUE),
    `1st Qu.` = quantile(x, 0.25, na.rm = TRUE),
    Median = median(x, na.rm = TRUE),
    Mean = mean(x, na.rm = TRUE),
    `3rd Qu.` = quantile(x, 0.75, na.rm = TRUE),
    Max = max(x, na.rm = TRUE)
  )
}

# Apply the function to each numeric variable in the dataset
summary_stats <- data %>%
  select_if(is.numeric) %>%
  summarise_all(list(calc_summary_stats))

# Unnest the list columns generated by summarise_all
summary_stats_unnested <- summary_stats %>%
  unnest(cols = everything(), names_repair = "minimal")

# Transpose the summary statistics for better readability
summary_stats_t <- t(summary_stats_unnested)

# Convert the transposed summary stats into a data frame
summary_df <- as.data.frame(summary_stats_t)

# Set proper column names after transposing
colnames(summary_df) <- c("Min", "1st Qu.", "Median", "Mean", "3rd Qu.", "Max")

# Add the variable names as a separate column
summary_df$Variable <- rownames(summary_df)

# Reorder the columns to place the Variable column first
summary_df <- summary_df[, c("Variable", "Min", "1st Qu.", "Median", "Mean", "3rd Qu.", "Max")]

# Print the final summary_df for review
print(summary_df)

# Print the formatted summary statistics table
kable(summary_df, format = "latex", row.names = FALSE)
```

**Objective 1 of the Case study**

*Conducting Inferential Statistics for health-related factors (BMI, HighBP, HighChol, PhysHlth)*

Step 1: Load the data and required packages (To ensure that the dataset is loaded and necessary libraries are installed)

```{r}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(MASS)

# Read the data set
data <- read.csv("/kaggle/input/diabetic-dataset/diabetes_dataset.csv")

# Convert relevant variables to categorical factors
data$HighBP <- factor(data$HighBP, levels = c(0, 1), labels = c("No High BP", "High BP"))
data$HighChol <- factor(data$HighChol, levels = c(0, 1), labels = c("No High Chol", "High Chol"))
data$PhysActivity <- factor(data$PhysActivity, levels = c(0, 1), labels = c("No", "Yes"))
data$Diabetes_binary <- factor(data$Diabetes_binary, levels = c(0, 1), labels = c("No Diabetes", "Diabetes or Pre-diabetes"))
```

Step 2: Descriptive Statistics (Summarise the data to get an understanding of the distribution)

BMI

```{r}
# Load necessary library
library(dplyr)
library(knitr)

# Summary for numeric variable (BMI)
bmi_summary <- summary(data$BMI)

# Create a data frame for BMI summary
bmi_summary_df <- data.frame(
  Statistic = names(bmi_summary),
  BMI = as.numeric(bmi_summary)
)

# Numeric variable (BMI) summary table
kable(bmi_summary_df, caption = "Summary Statistics for BMI")
```

Summary Statistics for High Blood Pressure

```{r}
summary(data$HighBP)
```

Summary Statistics for High Cholesterol Level

```{r}
summary(data$HighChol)
```

Summary Statistics of Physical Activity

```{r}
summary(data$PhysActivity)
```

Summary Statistics of Diabetes Binary

```{r}
summary(data$Diabetes_binary)
```

Step 3: Inferential Statistics - Chi Square Test for Categorical Variables

*Use of Chi Square Test is to evaluate the association between categorical variables (HighBP, HighChol, PhysActivity) and diabetes status.* 

```{r}
# Disable scientific notation
options(scipen=999)

# Chi-Square test for HighBP and Diabetes
chisq.test(data$HighBP, data$Diabetes_binary)

# Chi-Square test for HighChol and Diabetes
chisq.test(data$HighChol, data$Diabetes_binary)

# Chi-Square test for PhysActivity and Diabetes
chisq.test(data$PhysActivity, data$Diabetes_binary)

# Re-enable scientific notation (optional)
options(scipen=0)
```

Step 4: Inferential Statistics - T-test for Continuous Variable

*For the continuous variable BMI, use a t-test to compare the means between the diabetes and non-diabetes groups.*

```{r}
# Perform Welch Two Sample t-test
t_test_result <- t.test(data$BMI ~ data$Diabetes_binary)

# Extract components from the test result
t_statistic <- t_test_result$statistic
df <- t_test_result$parameter
p_value <- t_test_result$p.value
conf_int <- t_test_result$conf.int
mean_group1 <- t_test_result$estimate[1]
mean_group2 <- t_test_result$estimate[2]

# Formatting the output
cat("Welch Two Sample t-test\n\n")
cat("Data: `data$BMI` by `data$Diabetes_binary`\n\n")
cat(paste("t-statistic: ", round(t_statistic, 2), "\n", sep = ""))
cat(paste("Degrees of freedom (df): ", round(df, 3), "\n", sep = ""))
cat(paste("p-value: ", format.pval(p_value, digits = 20), "\n\n", sep = ""))
cat("Alternative Hypothesis:\n")
cat("The true difference in means between the group \"No Diabetes\" and the group \"Diabetes or Pre-diabetes\" is not equal to 0.\n\n")
cat("95% Confidence Interval:\n")
cat(paste("• Lower bound: ", round(conf_int[1], 6), "\n", sep = ""))
cat(paste("• Upper bound: ", round(conf_int[2], 6), "\n\n", sep = ""))
cat("Sample Estimates:\n")
cat(paste("• Mean BMI in the \"No Diabetes\" group: ", round(mean_group1, 5), "\n", sep = ""))
cat(paste("• Mean BMI in the \"Diabetes or Pre-diabetes\" group: ", round(mean_group2, 5), "\n", sep = ""))
```

Step 5: Logistic Regression

*Conduct logistic regression to model the likelihood of diabetes based on the health-related factors.*

```{r}
# Logistic Regression Model
logit_model <- glm(Diabetes_binary ~ BMI + HighBP + HighChol + PhysActivity, data = data, family = binomial)

# Summary of the model
summary(logit_model)
  
# Odds Ratios
exp(coef(logit_model))
```

**Objective 2 of the Case study**

*Determine the predictive power of lifestyle behaviors on diabetes risk*

Step 1: Data Preparation

```{r}
# Load necessary libraries
library(dplyr)

# Load the dataset
data <- read.csv("/kaggle/input/diabetic-dataset/diabetes_dataset.csv")

# Convert variables to appropriate data types
data$Diabetes_binary <- as.factor(data$Diabetes_binary)
data$Smoker <- as.factor(data$Smoker)
data$HvyAlcoholConsump <- as.factor(data$HvyAlcoholConsump)
data$MentHlth <- as.integer(data$MentHlth)

# View summary of the dataset
summary(data)
```

Step 2: Logistic Regression

```{r}
# Logistic regression model
model <- glm(Diabetes_binary ~ Smoker + HvyAlcoholConsump + MentHlth, data = data, family = binomial)

# Summary of the model
summary(model)
```

Step 3: Interpretation of Results

```{r}
# Calculate Odds Ratios
exp(coef(model))

# Confidence Intervals for Odds Ratios
exp(confint(model))
```

**Objective 3 of the Case study**

*Analyze the influence of socioeconomic factors on diabetes prevalence*

Step 1: Data Preparation

*Converting numerical variables into categorical variables*  
*Ensure that your data is properly loaded and the categorical variables are correctly defined*

```{r}
# Converting 'Age' variable into categorical variable
data$Age <- factor(data$Age,
                   levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13), # the numeric codes in order
                   labels = c("Age 18 - 24",
                              "Age 25 - 29",
                              "Age 30 - 34",
                              "Age 35 - 39",
                              "Age 40 - 44",
                              "Age 45 - 49",
                              "Age 50 - 54",
                              "Age 55 - 59",
                              "Age 60 - 64",
                              "Age 65 - 69",
                              "Age 70 - 74",
                              "Age 75 - 79",
                              "Age 80 or older"),
                   ordered = TRUE) # Specify that this is an ordinal factor

# Converting 'Education' variable into categorical variable
data$Education <- factor(data$Education,
                   levels = c(1, 2, 3, 4, 5, 6), # the numeric codes in order
                   labels = c("Never attended school or only kindergarten",
                              "Grades 1 - 8 (Elementary)",
                              "Grades 9 - 11 (Some high school)",
                              "Grade 12 or GED (High school graduate)",
                              "College 1 year to 3 years (Some college or technical school)",
                              "College 4 years or more (College graduate)"),
                   ordered = TRUE) # Specify that this is an ordinal factor

# Converting 'Income' variable into categorical variable
data$Income <- factor(data$Income,
                      levels = c(1, 2, 3, 4, 5, 6, 7, 8), # the numeric codes in order
                      labels = c("Less than $10,000",
                                 "$10,000 to $15,000",
                                 "$15,000 to $20,000",
                                 "$20,000 to $25,000",
                                 "$25,000 to $35,000",
                                 "$35,000 to $50,000",
                                 "$50,000 to $75,000",
                                 "$75,000 or more"),
                      ordered = TRUE) # Specify that this is an ordinal factor
```

Step 2: Perform EDA

*Perform some basic EDA to understand the distribution of your variables.*

```{r}
summary(data)
table(data$Diabetes) # Assuming 'Diabetes' is your dependent variable
```

Step 3: Logistic Regression Model

*Fit a logistic regression model with Age, Education, and Income as independent variables.*

```{r}
# Logistic regression model
model <- glm(Diabetes_binary ~ Age + Education + Income, data = data, family = binomial)

# Display the summary of the model
summary(model)
```

Step 4: Assessing Model Fit

*Evaluate the model fit using various metrics like AIC, and perform goodness-of-fit tests.*

```{r}
# AIC (Akaike Information Criterion)
AIC(model)

# Install package
install.packages("pscl")

# McFadden's R-squared
library(pscl)
pR2(model)
```

Step 5: Odds Ratio

*Calculate the odds ratios for easier interpretation of the coefficients.*

```{r}
exp(coef(model))
```

Step 6: Model Diagnostics

*Check for multicollinearity and influential observations.*

```{r}
# install package required
install.packages("car")

# Variance Inflation Factor (VIF)
library(car)
vif(model)

# Check residuals and leverage
plot(model)
```

Step 7: Prediction and Validation

*Make predictions and assess the model's predictive power.*

```{r}
# Predicted probabilities
data$predicted_prob <- predict(model, type = "response")

# Classification table
table(data$Diabetes, data$predicted_prob > 0.5)

# ROC curve and AUC
install.packages("pROC")
library(pROC)
roc_curve <- roc(data$Diabetes, data$predicted_prob)
plot(roc_curve)
auc(roc_curve)
```

