---
title: "Introduction to Linear Regression"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Setup

```{r}
# Load packages
if(!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse, openintro)

# Load the births14 dataset
data(births14)

# Filter for preemie babies and get last 8 rows
preemie_data <- births14 %>%
    filter(premie == "premie")

preemie_bottom8 <- preemie_data %>%
    slice_tail(n = 8) %>%
    mutate(weight_kg = weight * 0.453592)  # Convert pounds to kg
```

## Fit a Linear Model

```{r}
# Fit linear regression: weight_kg ~ weeks
model <- lm(weight_kg ~ weeks, data = preemie_bottom8)

# Extract slope and intercept
intercept <- coef(model)[1]
slope <- coef(model)[2]

# Display coefficients
cat("Intercept:", round(intercept, 3), "kg\n")
cat("Slope:", round(slope, 3), "kg per week\n")
```

## Add Predicted Values and Residuals

```{r}
# Add predicted values and residuals to the data
preemie_bottom8 <- preemie_bottom8 %>%
    mutate(
        predicted = predict(model),
        residual = weight_kg - predicted
    )

# View the data with predictions and residuals
preemie_bottom8 %>%
    select(weeks, weight_kg, predicted, residual)
```

## Visualizing the Linear Regression

```{r, fig.width=10, fig.height=8}
# Create plot showing regression line and residuals (focused view without extending to intercept)
ggplot(preemie_bottom8, aes(x = weeks, y = weight_kg)) +
    # Residual lines (vertical segments from points to regression line)
    geom_segment(
        aes(xend = weeks, yend = predicted),
        color = "red",
        linetype = "dashed",
        linewidth = 0.8
    ) +
    # Regression line
    geom_smooth(method = "lm", se = FALSE, color = "steelblue", linewidth = 1.2) +
    # Actual data points
    geom_point(size = 4, color = "black") +
    # Predicted points on the line
    geom_point(aes(y = predicted), size = 3, color = "steelblue", shape = 1, stroke = 1.5) +
    # Annotations for slope and intercept (as text box, not extending axes)
    annotate(
        "label",
        x = min(preemie_bottom8$weeks) + 0.5,
        y = max(preemie_bottom8$weight_kg) - 0.1,
        label = paste0(
            "Equation: weight = ", round(intercept, 2), " + ", round(slope, 2), " × weeks\n",
            "Intercept = ", round(intercept, 2), " kg (theoretical weight at week 0)\n",
            "Slope = ", round(slope, 2), " kg/week"
        ),
        hjust = 0,
        size = 3.5,
        fill = "white",
        label.size = 0.5
    ) +
    labs(
        title = "Linear Regression: Birthweight vs Gestational Weeks",
        subtitle = "Red dashed lines = Residuals | Blue circles = Predicted values",
        x = "Gestational Weeks",
        y = "Birthweight (kg)"
    ) +
    theme_minimal() +
    theme(
        plot.title = element_text(size = 14, face = "bold"),
        plot.subtitle = element_text(size = 11, color = "gray40")
    )
```

## Summary of Residuals

```{r}
# Show all residuals
cat("Residuals for each observation:\n")
for (i in 1:nrow(preemie_bottom8)) {
    cat(
        "Week", preemie_bottom8$weeks[i], 
        ": Actual =", round(preemie_bottom8$weight_kg[i], 2), "kg",
        ", Predicted =", round(preemie_bottom8$predicted[i], 2), "kg",
        ", Residual =", round(preemie_bottom8$residual[i], 2), "kg\n"
    )
}

cat("\nSum of residuals:", round(sum(preemie_bottom8$residual), 4), "kg\n")
cat("Sum of squared residuals (SSE):", round(sum(preemie_bottom8$residual^2), 4), "kg²\n")
```

## Model Summary

```{r}
summary(model)
```

